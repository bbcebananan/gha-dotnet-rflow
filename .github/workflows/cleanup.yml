name: Cleanup Artifacts

on:
  schedule:
    # Run every Sunday at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      days:
        description: 'Delete artifacts older than this many days'
        required: false
        default: '30'

permissions:
  actions: write

jobs:
  cleanup-artifacts:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Delete old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const days = parseInt('${{ github.event.inputs.days }}' || '30');
            const cutoff = new Date(Date.now() - days * 24 * 60 * 60 * 1000);

            console.log(`Deleting artifacts older than ${days} days (before ${cutoff.toISOString()})`);

            const artifacts = await github.paginate(
              github.rest.actions.listArtifactsForRepo,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              }
            );

            let deletedCount = 0;
            let totalSize = 0;

            for (const artifact of artifacts) {
              const createdAt = new Date(artifact.created_at);
              if (createdAt < cutoff) {
                console.log(`Deleting: ${artifact.name} (created: ${artifact.created_at}, size: ${artifact.size_in_bytes} bytes)`);
                try {
                  await github.rest.actions.deleteArtifact({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    artifact_id: artifact.id,
                  });
                  deletedCount++;
                  totalSize += artifact.size_in_bytes;
                } catch (error) {
                  console.log(`Failed to delete ${artifact.name}: ${error.message}`);
                }
              }
            }

            console.log(`\nSummary:`);
            console.log(`  Deleted: ${deletedCount} artifacts`);
            console.log(`  Freed: ${(totalSize / 1024 / 1024).toFixed(2)} MB`);

  cleanup-workflow-runs:
    name: Cleanup Old Workflow Runs
    runs-on: ubuntu-latest

    steps:
      - name: Delete old workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            const days = parseInt('${{ github.event.inputs.days }}' || '30');
            const cutoff = new Date(Date.now() - days * 24 * 60 * 60 * 1000);

            console.log(`Deleting workflow runs older than ${days} days`);

            // Get all workflows
            const workflows = await github.paginate(
              github.rest.actions.listRepoWorkflows,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
              }
            );

            let deletedCount = 0;

            for (const workflow of workflows) {
              const runs = await github.paginate(
                github.rest.actions.listWorkflowRuns,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflow.id,
                  per_page: 100
                }
              );

              for (const run of runs) {
                const createdAt = new Date(run.created_at);
                // Only delete completed runs that are old
                if (createdAt < cutoff && run.status === 'completed') {
                  try {
                    await github.rest.actions.deleteWorkflowRun({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      run_id: run.id,
                    });
                    deletedCount++;
                  } catch (error) {
                    // Ignore errors - some runs may not be deletable
                  }
                }
              }
            }

            console.log(`Deleted ${deletedCount} workflow runs`);
