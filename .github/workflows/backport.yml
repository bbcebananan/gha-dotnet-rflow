name: Backport to Release Branch

on:
  pull_request:
    types: [closed, labeled]
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  backport:
    name: Backport PR
    if: >
      github.event.pull_request.merged == true &&
      contains(toJson(github.event.pull_request.labels.*.name), 'backport')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get target branches from labels
        id: get-branches
        run: |
          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'
          BRANCHES=$(echo "$LABELS" | jq -r '.[] | select(startswith("backport ")) | sub("backport "; "")' | tr '\n' ' ')
          echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          echo "Found backport branches: $BRANCHES"

      - name: Cherry-Pick to Release Branch
        if: steps.get-branches.outputs.branches != ''
        uses: carloscastrojumo/github-cherry-pick-action@v1
        with:
          branch: ${{ steps.get-branches.outputs.branches }}
          labels: |
            cherry-pick
            automated
          title-prefix: '[Backport] '
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  label-guidance:
    name: Label Guidance
    if: >
      github.event.action == 'labeled' &&
      startsWith(github.event.label.name, 'backport ')
    runs-on: ubuntu-latest

    steps:
      - name: Add comment with instructions
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.label.name.replace('backport ', '');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `This PR is marked for backport to \`${branch}\`.

            When this PR is merged, a cherry-pick PR will be automatically created targeting the \`${branch}\` branch.

            **To backport to additional branches:** Add more labels in the format \`backport <branch-name>\`.

            **Available release branches:**
            - \`release/1.x\` - Version 1.x maintenance
            - \`release/2.x\` - Version 2.x maintenance (if applicable)`
            });
