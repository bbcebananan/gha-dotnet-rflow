name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

permissions:
  contents: write
  pull-requests: write
  packages: write

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      major: ${{ steps.release.outputs.major }}
      minor: ${{ steps.release.outputs.minor }}
      patch: ${{ steps.release.outputs.patch }}

    steps:
      - name: Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  build-and-publish:
    name: Build, Test & Publish
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.release-please.outputs.tag_name }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install dotnet-releaser
        run: dotnet tool install --global dotnet-releaser

      - name: Run dotnet-releaser
        run: |
          dotnet-releaser run `
            --github-token "${{ secrets.GITHUB_TOKEN }}" `
            dotnet-releaser.toml
        env:
          DOTNET_RELEASER_VERSION: ${{ needs.release-please.outputs.version }}

  build-msi:
    name: Build MSI Installer
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    runs-on: windows-latest

    strategy:
      matrix:
        architecture: [x64, arm64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.release-please.outputs.tag_name }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install WiX Toolset
        run: dotnet tool install --global wix

      - name: Add WiX Extensions
        run: wix extension add -g WixToolset.UI.wixext WixToolset.Util.wixext WixToolset.Iis.wixext

      - name: Build Application
        run: |
          dotnet publish src/MyApp/MyApp.csproj `
            -c Release `
            -r win-${{ matrix.architecture }} `
            --self-contained `
            -p:PublishSingleFile=false `
            -o ./publish/win-${{ matrix.architecture }}

      - name: Build MSI
        working-directory: installer
        run: |
          wix build Package.wxs IISConfiguration.wxs Directories.wxs Features.wxs `
            -arch ${{ matrix.architecture }} `
            -ext WixToolset.UI.wixext `
            -ext WixToolset.Util.wixext `
            -ext WixToolset.Iis.wixext `
            -d ProductVersion=${{ needs.release-please.outputs.version }} `
            -d InstallerPlatform=${{ matrix.architecture }} `
            -d PublishDir=..\publish\win-${{ matrix.architecture }} `
            -o ..\artifacts\MyApp-${{ needs.release-please.outputs.version }}-win-${{ matrix.architecture }}.msi

      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: msi-${{ matrix.architecture }}
          path: ./artifacts/*.msi

  upload-release-assets:
    name: Upload Release Assets
    needs: [release-please, build-msi]
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - name: Download x64 MSI
        uses: actions/download-artifact@v4
        with:
          name: msi-x64
          path: ./artifacts

      - name: Download arm64 MSI
        uses: actions/download-artifact@v4
        with:
          name: msi-arm64
          path: ./artifacts

      - name: Generate Checksums
        run: |
          cd artifacts
          sha256sum *.msi > checksums.txt
          cat checksums.txt

      - name: Upload MSI to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: |
            ./artifacts/*.msi
            ./artifacts/checksums.txt

  announce:
    name: Announce Release
    needs: [release-please, build-and-publish, upload-release-assets]
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - name: Send Teams Notification
        if: ${{ vars.TEAMS_WEBHOOK_URL != '' }}
        run: |
          curl -H "Content-Type: application/json" -d '{
            "@type": "MessageCard",
            "@context": "http://schema.org/extensions",
            "themeColor": "0076D7",
            "summary": "New Release: ${{ needs.release-please.outputs.version }}",
            "sections": [{
              "activityTitle": "MyApp ${{ needs.release-please.outputs.version }} Released",
              "facts": [{
                "name": "Version",
                "value": "${{ needs.release-please.outputs.version }}"
              }, {
                "name": "Tag",
                "value": "${{ needs.release-please.outputs.tag_name }}"
              }],
              "markdown": true
            }],
            "potentialAction": [{
              "@type": "OpenUri",
              "name": "View Release",
              "targets": [{
                "os": "default",
                "uri": "https://github.com/${{ github.repository }}/releases/tag/${{ needs.release-please.outputs.tag_name }}"
              }]
            }]
          }' ${{ vars.TEAMS_WEBHOOK_URL }}
